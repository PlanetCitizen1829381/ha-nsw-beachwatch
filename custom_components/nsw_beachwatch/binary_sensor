import logging
from homeassistant.components.binary_sensor import BinarySensorEntity, BinarySensorDeviceClass
from homeassistant.helpers.update_coordinator import CoordinatorEntity
from homeassistant.helpers.entity import DeviceInfo
from .const import DOMAIN, MANUFACTURER

_LOGGER = logging.getLogger(__name__)

ADVICE_MAP = {
    "unlikely": {
        "risk": "Pollution Unlikely"
    },
    "possible": {
        "risk": "Pollution Possible"
    },
    "likely": {
        "risk": "Pollution Likely"
    },
    "forecast not available": {
        "risk": "No Forecast"
    }
}

async def async_setup_entry(hass, entry, async_add_entities):
    coordinator = hass.data[DOMAIN][entry.entry_id]
    binary_sensors = [
        BeachwatchBinarySensor(coordinator, entry, "safe_to_swim")
    ]
    async_add_entities(binary_sensors)

class BeachwatchBinarySensor(CoordinatorEntity, BinarySensorEntity):
    def __init__(self, coordinator, entry, key):
        super().__init__(coordinator)
        self._key = key
        self._beach_name = entry.data["beach_name"]
        self._attr_unique_id = f"{entry.entry_id}_{key}"
        self._attr_has_entity_name = True
        self._attr_translation_key = key
        self._attr_device_class = BinarySensorDeviceClass.SAFETY
        self._attr_device_info = DeviceInfo(
            identifiers={(DOMAIN, entry.entry_id)},
            name=self._beach_name,
            manufacturer=MANUFACTURER,
            model="NSW Beachwatch API",
            configuration_url="https://www.beachwatch.nsw.gov.au"
        )

    @property
    def is_on(self):
        data = self.coordinator.data
        if not data:
            return None
        forecast = str(data.get("forecast", "Unknown")).lower()
        return forecast == "unlikely"

    @property
    def extra_state_attributes(self):
        attrs = {}
        data = self.coordinator.data
        if data:
            forecast = str(data.get("forecast", "Unknown")).lower()
            advice_info = ADVICE_MAP.get(forecast, {})
            attrs["forecast"] = data.get("forecast", "Unknown")
            attrs["risk_level"] = advice_info.get("risk", "Unknown")
            
            region = data.get("region")
            if region:
                attrs["region"] = region
            
            council = data.get("council")
            if council:
                attrs["council"] = council
            
            attrs["attribution"] = "Data provided by NSW Beachwatch"
        return attrs
